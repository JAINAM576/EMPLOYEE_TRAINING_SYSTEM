<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>


</head>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>



<link href="http://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.2/jquery.min.js"
    integrity="sha512-tWHlutFnuG0C6nQRlpvrEhE4QpkG1nn2MOUMWmUeRePl4e3Aki0VB6W1v3oLjFtd0hVOtRQ9PHpSfN6u6/QXkQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
<style>
    * {
        margin: 0;
        padding: 0;

    }

    .main {
        height: 100%;
        width: 100%;
        min-height: 100vh;
        /* background-color: rgba(211, 205, 205, 0.74); */
        display: flex;
        justify-content: center;
        z-index: -1;
    }


 

    .h2 {
        text-align: center;
        border-bottom: 2px solid black;
        width: 100%;
    }

    .info {
        width: 50%;
        height: 60%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .field {

        border: 2px solid gray;
        width: 100%;
        height: 100%;
        padding: 10px 30px;
    }

    #btn,#btn1 {
        margin-top: 10px;
    }
    .check{
        display: none;
    }
    .main2 {

position: sticky;
display: flex;
justify-content: center;
align-items: center;
/* min-height: 100vh; */
bottom: 50%;
width: 100%;
height: 100%;
min-height: 100vh;
font-weight: bold;
display: none;
}
.box {
            width: 70%;
            background-color: white;
            z-index: 1;
            box-shadow: 2px 2px 2px rgba(255, 255, 255, 0.639);
            border: 2px solid black;
            border-radius: 5px;
            padding: 5px 5px;
            height: 100%;
        }

        .info1{
            width: 100%;
            flex-direction: column;
            padding: 10px 5px;
            display: flex;
           
            justify-content: center;
        }
        .details{
            margin: 5px 1px;
            text-transform: capitalize;


        }
#getting_error{
    display: none;
}
</style>

<body>
    <div class="main" id="main">
        <div class="info">
            <h2 class="h2">Exam Result</h2>
            <hr style="background-color: black;">
            <div class="field">
                <label for="year">Year:</label>
                <select class="form-select" aria-label="Default select example" id="year">
                    <option selected>Select year</option>
                    <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3"></option>
                </select>
                <label for="emp_id">Enter your emp_id:</label>


                <input type="text" disabled class="form-control" placeholder="Username" id="emp_id"
                    aria-label="Username" aria-describedby="basic-addon1">
                    
                    <button type="button" id="btn" class="btn btn-primary">Go</button>
                    <hr>
                    <div id="after_selection" class="check">
                        <h3 id="msg"></h3>
                        <div id="training">

                            <label for="sel1" class="form-label">Training :</label>
                            
                            <select class="form-select form-control" id="sel1" name="spipa_name" disabled>
                                <option selected value="-1">Select Training</option>
                                
                            </select>
                            <label for="sel2" class="form-label">Subject :</label>
                            <select class="form-select form-control" id="sel2" name="spipa_name" disabled>
                                <option selected value="-1" disabled>Select Subject</option>
                                
                            </select>
                            <button type="button" id="btn1" class="btn btn-primary">Check result</button>
                            <div class="error">
                                <h2 id="getting_error">Sorry data is not availabel!</h2>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
      
    </div>
    <div class="main2" id="main2">
        <div class="box">
            <div class="info1" id="adder">

            </div>
            <div class="feed">
            U can Download certificate here if u are eligible.
                <hr>
                <button class="btn btn-danger" id="exit">Exit</button>
                <!-- <button class="btn btn-danger" id="certi">Download certi</button> -->
                <a href="#" class="btn btn-danger" id="certi">Download Certificate</a>
            </div>
        </div>
    </div>
    <canvas id="canvas" height="500px" width="800px"  style="display: none;"  ></canvas>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
<script>
let exit=document.getElementById('exit')
let certi=document.getElementById('certi')
    let year = document.getElementById('year')
    let btn = document.getElementById('btn')
    let btn1 = document.getElementById('btn1')
    let sel1 = document.getElementById('sel1')
    let sel2 = document.getElementById('sel2')
    let emp_id = document.getElementById('emp_id')
    let after_selection = document.getElementById('after_selection')
    let training = document.getElementById('training')
    let msg = document.getElementById('msg')
let main=document.getElementById('main')
let main2=document.getElementById('main2')
let adder=document.getElementById('adder')
let getting_error=document.getElementById('getting_error')


//canvas
var canvas = document.getElementById('canvas')

var ctx = canvas.getContext('2d')
var image = new Image()
image.crossOrigin="anonymous";
image.src = '/give'
image.onload = function () {
	drawImage()
}


//making function for generating certificate

let iseligible=true
let name_my;
let text;
let text1;
let check=true
function drawImage(e) {
	// ctx.clearRect(0, 0, canvas.width, canvas.height)
    if(!iseligible){
        alert('sorry you are not eligible for the certificate')
return 
    }
    if(check){
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height)
return ;
    }
    ctx.drawImage(image, 0, 0, canvas.width, canvas.height)
	ctx.font = '40px monotype corsiva'
	ctx.fillStyle = 'black'
	ctx.fillText(name_my, (canvas.width/2)-(name_my.length*8), (canvas.height/2)-40)
	ctx.textBaseline = "bottom";
	

			ctx.font = '16px Arial'
		
			ctx.fillStyle = 'black'
			ctx.fillText(text, 240,290)
			ctx.font = '16px Arial'
			ctx.fillStyle = 'black'
			ctx.fillText(text1, 165,310)
		
	
}


    let j = '<option selected value=-1>Select year</option> ';
    for (let i = 0; i < 3; i++) {

        j += `<option value=${new Date().getFullYear() - i}>${new Date().getFullYear() - i}</option>`

    }
    year.innerHTML = j
    year.addEventListener('change', (e) => {
        if (year.value != "-1") {
            emp_id.disabled = false
        }
        else {
            emp_id.value = ""
            emp_id.disabled = true
        }
    })

    btn.addEventListener('click', () => {
        let obj = {
            date: year.value,
            emp_id: emp_id.value,
        }
        if(obj.date.length==-1 || obj.emp_id.length==0 ){
            alert("Please fill form properly")
            return ;
        }




        $.ajax({
            type: 'post',
            url: '/emp_year_check',
            data: JSON.stringify(obj),
            contentType: 'application/json; charset=utf-8',
            traditional: true,
            success: function (data, status) {
                console.log(data, "data kj")
                if (data.length == 0) {


                    after_selection.style.display='block'
                    training.style.display='none'
                    msg.style.display='block'
                    msg.innerText="Sorry !your data is not availabel"


                } 
                else {
                    let j = `<option selected value=-1> Select training</option>`
                    let arr=[]
                    data.forEach(element => {
                        if(arr.includes(element.emp_training)==false){

                            j += `<option value=${element.emp_training}>${element.emp_training}</option>`
                            arr.push(element.emp_training);
                        }
                    })
                    sel1.innerHTML = j;
                    let arr1=[]
                    j = `<option selected value=-1> Select Subject</option>`
                    let arr2=[]
                    data.forEach(element => {
                        
                        if(arr2.includes(element.emp_training_subject)==false){
                            j += `<option value=${element.emp_training_subject}>${element.emp_training_subject}</option>`
                            arr2.push(element.emp_training_subject)
                        }
                    })
                    sel2.innerHTML = j
                    sel1.disabled=false
                    sel2.disabled=false
                    after_selection.style.display='block'
                    training.style.display='block'
                    msg.style.display='none'
                }
            }

        })
    })
    btn1.addEventListener('click',function(){
        let obj = {
    
            emp_id: emp_id.value,
            training_name:sel1.value,
            subject:sel2.value
        }
        if(obj.emp_id.length==0 || obj.training_name==-1 ||  obj.subject==-1){
            alert("Please fill form properly")
            return ;
        }

        $.ajax({
            type: 'post',
            url: '/emp_marks_check',
            data: JSON.stringify(obj),
            contentType: 'application/json; charset=utf-8',
            traditional: true,
            success: function (data, status) {
                console.log(data, "data kj marks")
                if (data.length == 0) {

                    getting_error.style.display='block'
                    setTimeout(() => {
                        getting_error.style.display='none'
                    }, 2000);
                 
                } 
                else {
                    main.style.filter = 'blur(1px)'
        main2.style.display = 'flex'
        let j='<h2>RESULT CARD</h2>'
        let msg;
        let color;
        if(data[0].marks>=33){
            msg='Congratulations!You passed in your exam'
            color='lime'

        }
        else{
            msg='Unfortunately ! You failed in your exam'
            color='red'
            iseligible=false
        }
        name_my=data[0].emp_name
        text=`For attending Trainning namely ${obj.training_name}`
        text1=`and performing good in  ${obj.subject} u r certified by our company spipa.`
       
        j+=`<div class="details">Your name: ${data[0].emp_name} </div>
        <hr>
        <div class="details">Email :  ${data[0].emp_email}</div>
        <hr>
        <div class="details">DOB :  ${data[0].emp_birth_date} </div>
        <hr>
        <div class="details">Gender :  ${data[0].emp_gender} </div>
        <hr>
        <h3 class="greeting" id="greet">${msg}</h3>
        <hr>
        <h2 class="result ">You got ${data[0].marks} marks out of ${data[0].out_of} </h2>
        
        `
        adder.innerHTML=j;
        document.getElementById('greet').style.color=color
                }
            }

        })
    })
   
    exit.addEventListener('click', (e) => {
        main.style.filter = 'blur(0px)'
        main2.style.display = 'none'
    })
    
certi.addEventListener('click', function () {
    check=false
    drawImage()
    if(!iseligible){
        return ;
    }
	certi.href = canvas.toDataURL('image/jpg')
	certi.download = 'Certificate - ' + name_my
})



</script>

</html>