<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <style>
        :root {
            --ssip-back: #ffffff;
            --ssip-primary: #E12828;
            --ssip-primary-rgb: 224, 41, 41;
            --ssip-secondary: #F5533D;
            --ssip-front: #010101;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0 12%;
            box-sizing: border-box;
        }

        #timmer {
            font-size: 2rem !important;
            font-weight: 700;
            padding: 8px 16px;
            position: fixed;
            top: 0;
            left: 0;
            background-color: var(--ssip-primary);
            color: var(--ssip-back);
        }

        #exam_info {
            padding: 10px 20px;
            margin-top: 80px;
            border-radius: 5px;
            color: black;
            font-size: 1.5rem;
            border: 2px solid black;
        }

        .que_box {
            margin: 10px;
        }

        .que_box>div {
            margin-top: 10px;
        }

        .que_box input {
            margin-left: 10px;
        }

        .que_box label {
            margin-left: 10px;
        }
    </style>
</head>

<body id="body">
    <p id="timmer"></p>
    <div class="row" style="width: 100%;">
        <div class="col-12 " id="exam_info">
            <p id="exam_name"></p>
            <p id="exam_time"></p>
            <p id="exam_sub"></p>
            <p id="exam_training"></p>
            <p id="exam_total"></p>
        </div>
        <form class="mt-5" id="que_form">
            <h2>Questions</h2>
            <div class="row" id="all_que">

            </div>
            <button class="btn btn-primary m-4 " id="submit_button" type="button">Submit</button>
        </form>
    </div>

    <script>
        //check cookie
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
        const user = getCookie("user");
        const exam = getCookie("exam");
        var countDownDate;
        var total;
        $.get(`/quiz/exam-info/${exam}`, (data, status) => {
            console.log("", data);
            countDownDate = addMinutes(new Date(), Number(data[0].exam_time.slice(3, 5)), Number(data[0].exam_time.slice(0, 2)));

            $("#exam_name").append(`Exam Name: ` + data[0].exam_name);
            $("#exam_time").append(`Exam Time: ` + data[0].exam_time.slice(0, 2) + ` hour ` + data[0].exam_time.slice(3, 5) + ` Minutes`);
            $("#exam_sub").append(`Exam Subject: ` + data[0].exam_sub);
            $("#exam_training").append(`Exam training: ` + data[0].exam_training);
            $("#exam_total").append(`Exam total: ` + data[0].total_marks);
        });
        $.get(`/quiz/questions/${exam}`, (data, status) => {
            console.log("", data)
            var que;
            for (let x = 0; x < data.length; x++) {
                que = `<div class="que_box" id="que_box_` + data[x].que_no + `" class="row">
                    <h4 class="col-12" id="que_`+ data[x].que_no + `">` + data[x].que_no + `. ` + data[x].que_statement + ` (Marks:` + data[x].marks + `)</h4>
                    <div class="form-check col-12">
                        <input type="radio" class="form-check-input" value='1' name="que_`+ data[x].que_no + `">
                        <label class="form-check-label" for="radio1_`+ data[x].que_no + `">` + data[x].que_option_1 + `</label>
                    </div>
                    <div class="form-check col-12">
                        <input type="radio" class="form-check-input" value='2'  name="que_`+ data[x].que_no + `">
                        <label class="form-check-label" for="radio2_`+ data[x].que_no + `">` + data[x].que_option_2 + `</label>
                    </div>
                    <div class="form-check col-12">
                        <input type="radio" class="form-check-input" value='3'  name="que_`+ data[x].que_no + `">
                        <label class="form-check-label" for="radio3_`+ data[x].que_no + `">` + data[x].que_option_3 + `</label>
                    </div>
                    <div class="form-check col-12">
                        <input type="radio" class="form-check-input" value='4'  name="que_`+ data[x].que_no + `">
                        <label class="form-check-label" for="radio4_`+ data[x].que_no + `">` + data[x].que_option_4 + `</label>
                    </div>
                </div>`;
                $("#all_que").append(que);
            }
            total = data.length;
        });
        function addMinutes(date, minutes, hours) {
            date.setMinutes(date.getMinutes() + minutes + ((60) * hours));
            return date;
        }


        // Update the count down every 1 second
        var x = setInterval(function () {

            // Get today's date and time
            var now = new Date().getTime();

            // Find the distance between now and the count down date
            var distance = countDownDate - now;

            // Time calculations for days, hours, minutes and seconds
            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Output the result in an element with id="demo"
            document.getElementById("timmer").innerHTML = "Time: " + hours + "h "
                + minutes + "m " + seconds + "s ";

            // If the count down is over, write some text 
            if (distance < 0) {
                clearInterval(x);
                $("#submit_button").click()
                alert("time over your response is added")               
                document.getElementById("body").innerHTML = "Time Over your response is added";
            }
        }, 1000);



        //submit
        $(document).ready(function () {
            $("#submit_button").click(function () {
               
                const que_ans = [];
                for (let x = 0; x < total; x++) {
                    ans = $('input[name=que_' + (x + 1) + ']:checked', '#que_form').val();
                    if (!ans) ans = '0'
                    que_ans.push(ans);
                }
                
                const reqBody = {
                    que_ans: que_ans,
                    user:user,
                    exam:exam
                };

                $.ajax({
                    type: 'post',
                    url: '/quiz/submit',
                    data: JSON.stringify(reqBody),
                    contentType: "application/json; charset=utf-8",
                    traditional: true,
                    success: function (data) {
                        if (data==1) {
                            alert('submitted successfully');
                            setCookie("exam", $(exam_name).val(),1)
                            window.location.assign("/employee");
                        }
                        else if(data==2){
                            alert("already given");
                        }
                        else if(data==3){
                            alert("Sign in first");
                            window.location.assign("/employee");
                        }
                        else{
                            alert("error");
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert("error: " + thrownError)
                    }
                });
                //que no. n has it's ans in que_ans[n-1]
            });
        });

    </script>
</body>

</html>